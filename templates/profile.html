{% extends 'base.html' %}
{% block title %}@{{ user.username }} ‚Äî MySocial{% endblock %}

{% block body %}
<div class="app-container">

  <aside class="sidebar-left">
    <div class="sidebar-logo">MySocial</div>
    <a href="/" class="nav-item"><span class="nav-icon">üè†</span> –°—Ç—Ä—ñ—á–∫–∞</a>
    <a href="/search" class="nav-item"><span class="nav-icon">üîç</span> –ü–æ—à—É–∫</a>
    <a href="/notifications" class="nav-item"><span class="nav-icon">üîî</span> –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è<span class="nav-badge" data-notif></span></a>
    <a href="/profile/{{ session.username }}" class="nav-item active"><span class="nav-icon">üë§</span> –ü—Ä–æ—Ñ—ñ–ª—å</a>
    <button class="sidebar-post-btn" onclick="openModal('modal-post')">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å—Ç</button>
    <a href="/profile/{{ session.username }}" class="sidebar-user">
      {% if session.get('avatar_img') %}<img src="/static/uploads/{{ session.avatar_img }}" class="avatar avatar-sm" style="object-fit:cover;">
      {% else %}<div class="avatar avatar-sm" style="background:{{ session.get('accent','#6366f1') }}">{{ session.username[0].upper() }}</div>{% endif %}
      <div class="sidebar-user-info"><div class="sidebar-username">{{ session.username }}</div></div>
    </a>
  </aside>

  <main class="main-feed">
    <div class="top-bar">
      <a href="/" style="color:var(--text-1);font-size:1.3rem;text-decoration:none;padding:4px;">‚Üê</a>
      <div style="font-weight:700;">@{{ user.username }}</div>
      <div style="width:32px;"></div>
    </div>

    {# ‚îÄ‚îÄ Profile Header ‚îÄ‚îÄ #}
    <div class="profile-header">
      <div class="profile-top">
        {% if user.avatar_img %}
          <img src="/static/uploads/{{ user.avatar_img }}" class="avatar avatar-xl" style="object-fit:cover;width:88px;height:88px;">
        {% else %}
          <div class="avatar avatar-xl" style="background:{{ user.avatar_color }};width:88px;height:88px;font-size:2rem;">{{ user.username[0].upper() }}</div>
        {% endif %}
        <div class="profile-stats">
          <div class="profile-stat" style="cursor:default;">
            <div class="profile-stat-value">{{ post_rows|length }}</div>
            <div class="profile-stat-label">–ü–æ—Å—Ç—ñ–≤</div>
          </div>
          <div class="profile-stat" style="cursor:pointer;" onclick="openFollowersModal()">
            <div class="profile-stat-value">{{ followers_count }}</div>
            <div class="profile-stat-label">–ß–∏—Ç–∞—á—ñ–≤</div>
          </div>
          <div class="profile-stat" style="cursor:pointer;" onclick="openFollowingModal()">
            <div class="profile-stat-value">{{ following_count }}</div>
            <div class="profile-stat-label">–ß–∏—Ç–∞—î</div>
          </div>
        </div>
      </div>

      <div class="profile-bio-section">
        <div class="profile-fullname">{{ user.username }}</div>
        {% if user.bio %}<div class="profile-bio">{{ user.bio }}</div>{% endif %}
      </div>

      {% if session.user_id == user.id %}
        <a href="/profile/{{ user.username }}/edit" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</a>
      {% else %}
        <button class="btn-follow follow-btn-ajax {% if is_following %}following{% endif %}"
                data-user-id="{{ user.id }}">
          {% if is_following %}–ü—ñ–¥–ø–∏—Å–∞–Ω–∏–π{% else %}–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—å{% endif %}
        </button>
      {% endif %}
    </div>

    <div class="divider"></div>

    {# ‚îÄ‚îÄ Posts Grid ‚îÄ‚îÄ #}
    {% if not post_rows %}
      <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <div class="empty-text">–ù–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤</div>
      </div>
    {% else %}
      <div class="profile-grid" id="profile-grid">
        {% for row in post_rows %}
        {% set post = row.post %}
        {% set media = row.media %}
        <div class="profile-grid-item" onclick="openPostModal({{ post.id }})">
          {% if media and media[0].media_type == 'image' %}
            <img src="/static/uploads/{{ media[0].filename }}" style="width:100%;height:100%;object-fit:cover;">
          {% elif media and media[0].media_type == 'video' %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg-3);font-size:2rem;">üé¨</div>
          {% elif media and media[0].media_type == 'audio' %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg-3);font-size:2rem;">üéµ</div>
          {% else %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg-3);padding:12px;">
              <span style="font-size:0.85rem;color:var(--text-2);text-align:center;line-height:1.4;">{{ post.content[:80] }}</span>
            </div>
          {% endif %}
          <div class="profile-grid-overlay">
            <span>‚ù§Ô∏è {{ post.like_count }}</span>
            <span>üí¨ {{ post.comment_count }}</span>
          </div>
          {% if session.user_id == user.id %}
            <button class="grid-delete-btn" onclick="event.stopPropagation();deletePost({{ post.id }}, this.closest('.profile-grid-item'))">üóë</button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </main>
  <aside class="sidebar-right"></aside>
</div>

{# ‚îÄ‚îÄ Followers Modal ‚îÄ‚îÄ #}
<div class="modal-overlay" id="modal-followers" onclick="if(event.target===this)closeModal('modal-followers')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="follow-modal-title">–ß–∏—Ç–∞—á—ñ</div>
    <div id="follow-list" style="max-height:60vh;overflow-y:auto;">
      <div style="text-align:center;padding:24px;color:var(--text-3);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ Post Detail Modal ‚îÄ‚îÄ #}
<div class="modal-overlay" id="modal-post-detail" onclick="if(event.target===this)closeModal('modal-post-detail')">
  <div class="modal-sheet" style="max-height:90vh;overflow-y:auto;padding:0;">
    <div id="post-detail-content" style="padding:20px;"></div>
  </div>
</div>

<nav class="bottom-nav">
  <a href="/" class="bottom-nav-item"><span class="bnav-icon">üè†</span><span>–°—Ç—Ä—ñ—á–∫–∞</span></a>
  <a href="/search" class="bottom-nav-item"><span class="bnav-icon">üîç</span><span>–ü–æ—à—É–∫</span></a>
  <div class="bottom-nav-post"><button class="bottom-nav-post-btn" onclick="openModal('modal-post')">Ôºã</button></div>
  <a href="/notifications" class="bottom-nav-item"><span class="bnav-icon">üîî</span><span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span><span class="bnav-badge" data-notif></span></a>
  <a href="/profile/{{ session.username }}" class="bottom-nav-item active"><span class="bnav-icon">üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></a>
</nav>

<script>
const PROFILE_USER_ID = {{ user.id }};

async function openFollowersModal() {
  document.getElementById('follow-modal-title').textContent = '–ß–∏—Ç–∞—á—ñ';
  openModal('modal-followers');
  await loadFollowList(`/api/users/${PROFILE_USER_ID}/followers`);
}
async function openFollowingModal() {
  document.getElementById('follow-modal-title').textContent = '–ß–∏—Ç–∞—î';
  openModal('modal-followers');
  await loadFollowList(`/api/users/${PROFILE_USER_ID}/following`);
}

async function loadFollowList(url) {
  const list = document.getElementById('follow-list');
  list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-3);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  try {
    const res = await fetch(url);
    const users = await res.json();
    if (!users.length) {
      list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-3);">–ü–æ—Ä–æ–∂–Ω—å–æ</div>';
      return;
    }
    list.innerHTML = users.map(u => `
      <div style="display:flex;align-items:center;gap:12px;padding:12px 4px;border-bottom:1px solid var(--border);">
        <a href="/profile/${escHtml(u.username)}">
          ${u.avatar_img
            ? `<img src="/static/uploads/${u.avatar_img}" class="avatar avatar-md" style="object-fit:cover;">`
            : `<div class="avatar avatar-md" style="background:${u.avatar_color}">${u.username[0].toUpperCase()}</div>`}
        </a>
        <a href="/profile/${escHtml(u.username)}" style="flex:1;font-weight:600;font-size:0.9rem;">@${escHtml(u.username)}</a>
        ${u.id != {{ session.user_id }} ? `
          <button class="follow-btn-ajax ${u.is_following ? 'following' : ''}"
                  data-user-id="${u.id}"
                  style="padding:7px 16px;border-radius:8px;border:1.5px solid var(--border);background:${u.is_following?'var(--bg-3)':'var(--accent-grad)'};color:${u.is_following?'var(--text-1)':'white'};font-weight:600;font-size:0.8rem;cursor:pointer;">
            ${u.is_following ? '–ü—ñ–¥–ø–∏—Å–∞–Ω–∏–π' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—å'}
          </button>` : ''}
      </div>`).join('');
  } catch(e) {
    list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-3);">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
  }
}

async function deletePost(postId, el) {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) return;
  try {
    const res = await fetch(`/api/posts/${postId}/delete`, {method:'POST'});
    const data = await res.json();
    if (data.deleted) {
      el.style.transition = 'opacity 0.3s, transform 0.3s';
      el.style.opacity = '0'; el.style.transform = 'scale(0.8)';
      setTimeout(() => el.remove(), 300);
      showToast('–ü–æ—Å—Ç –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
    }
  } catch(e) { showToast('–ü–æ–º–∏–ª–∫–∞', 'error'); }
}

async function openPostModal(postId) {
  openModal('modal-post-detail');
  const content = document.getElementById('post-detail-content');
  content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-3);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  // For now show a simple message - full post detail can be added later
  content.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-2);font-size:0.9rem;">–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ —Å—Ç—Ä—ñ—á–∫–∏ —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Å—Ç</div>`;
}
</script>
{% endblock %}