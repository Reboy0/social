{% extends 'base.html' %}
{% block title %}–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Äî MySocial{% endblock %}

{% block body %}
<div class="app-container">
  <aside class="sidebar-left">
    <div class="sidebar-logo">MySocial</div>
    <a href="/" class="nav-item"><span class="nav-icon">üè†</span> –°—Ç—Ä—ñ—á–∫–∞</a>
    <a href="/search" class="nav-item"><span class="nav-icon">üîç</span> –ü–æ—à—É–∫</a>
    <a href="/notifications" class="nav-item"><span class="nav-icon">üîî</span> –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</a>
    <a href="/profile/{{ session.username }}" class="nav-item active"><span class="nav-icon">üë§</span> –ü—Ä–æ—Ñ—ñ–ª—å</a>
    <button class="sidebar-post-btn" onclick="openModal('modal-post')">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å—Ç</button>
    <a href="/profile/{{ session.username }}" class="sidebar-user">
      <div class="avatar avatar-sm" style="background:{{ session.get('accent','#6366f1') }}">{{ session.username[0].upper() }}</div>
    </a>
  </aside>

  <main class="main-feed">
    <div class="top-bar">
      <a href="/profile/{{ user.username }}" style="color:var(--text-1);font-size:1.2rem;text-decoration:none;">‚Üê</a>
      <div style="font-weight:700;">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</div>
      <div style="width:24px;"></div>
    </div>

    <form action="/profile/{{ user.username }}/edit" method="POST" enctype="multipart/form-data">

      {# Avatar upload #}
      <div class="settings-section">
        <div class="settings-label">–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é</div>
        <div style="display:flex;align-items:center;gap:20px;">
          <div id="avatar-preview" style="position:relative;cursor:pointer;" onclick="document.getElementById('avatar-file').click()">
            {% if user.avatar_img %}
              <img src="/static/uploads/{{ user.avatar_img }}" class="avatar avatar-xl" style="object-fit:cover;width:88px;height:88px;">
            {% else %}
              <div class="avatar avatar-xl" style="background:{{ user.avatar_color }};width:88px;height:88px;font-size:2rem;">
                {{ user.username[0].upper() }}
              </div>
            {% endif %}
            <div style="position:absolute;inset:0;background:rgba(0,0,0,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;" id="avatar-overlay">
              <span style="color:white;font-size:1.3rem;">üì∑</span>
            </div>
          </div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;">{{ user.username }}</div>
            <button type="button" onclick="document.getElementById('avatar-file').click()"
                    style="background:none;border:none;color:var(--accent);font-weight:600;font-size:0.875rem;cursor:pointer;padding:0;margin-top:4px;">
              –ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ—Ç–æ
            </button>
          </div>
        </div>
        <input type="file" name="avatar_file" id="avatar-file" accept="image/*" style="display:none;"
               onchange="previewAvatar(this)">
      </div>

      {# Bio #}
      <div class="settings-section">
        <div class="settings-label">–ë—ñ–æ</div>
        <textarea class="textarea-input" name="bio" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ..." maxlength="200">{{ user.bio or '' }}</textarea>
      </div>

      {# Avatar color (fallback) #}
      <div class="settings-section">
        <div class="settings-label">–ö–æ–ª—ñ—Ä –∞–≤–∞—Ç–∞—Ä–∞ (—è–∫—â–æ –Ω–µ–º–∞—î —Ñ–æ—Ç–æ)</div>
        <div class="color-grid">
          {% for color in ['#6366f1','#a855f7','#ec4899','#f43f5e','#f97316','#eab308','#10b981','#06b6d4','#3b82f6','#0f172a','#78716c','#64748b'] %}
            <div class="color-swatch {% if user.avatar_color == color %}selected{% endif %}"
                 style="background:{{ color }}"
                 onclick="this.closest('.color-grid').querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));this.classList.add('selected');document.querySelector('[name=avatar_color]').value='{{ color }}'">
            </div>
          {% endfor %}
        </div>
        <input type="hidden" name="avatar_color" value="{{ user.avatar_color }}">
      </div>

      {# Accent color #}
      <div class="settings-section">
        <div class="settings-label">–ê–∫—Ü–µ–Ω—Ç–Ω–∏–π –∫–æ–ª—ñ—Ä</div>
        <div class="color-grid">
          {% for color in ['#6366f1','#a855f7','#ec4899','#f43f5e','#f97316','#eab308','#10b981','#06b6d4','#3b82f6'] %}
            <div class="color-swatch {% if user.accent_color == color %}selected{% endif %}"
                 style="background:{{ color }}"
                 onclick="this.closest('.color-grid').querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));this.classList.add('selected');document.querySelector('[name=accent_color]').value='{{ color }}';setAccentColor('{{ color }}')">
            </div>
          {% endfor %}
        </div>
        <input type="hidden" name="accent_color" value="{{ user.accent_color }}">
      </div>

      {# Theme #}
      <div class="settings-section">
        <div class="settings-label">–¢–µ–º–∞</div>
        <div class="theme-toggle-row">
          <div class="theme-label">–¢–µ–º–Ω–∞ —Ç–µ–º–∞</div>
          <button type="button" class="toggle-switch {% if user.theme == 'dark' %}on{% endif %}"
                  onclick="const n=toggleTheme();document.querySelector('[name=theme]').value=n;"></button>
        </div>
        <input type="hidden" name="theme" value="{{ user.theme or 'light' }}">
      </div>

      <div class="settings-section">
        <button type="submit" style="width:100%;padding:13px;background:var(--accent-grad);border:none;border-radius:12px;color:white;font-weight:700;font-size:0.95rem;cursor:pointer;">
          –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
        </button>
        <a href="/profile/{{ user.username }}" style="display:block;text-align:center;margin-top:10px;color:var(--text-2);font-size:0.875rem;">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
      </div>

      <div class="settings-section" style="border:none;">
        <a href="/logout" style="color:#ef4444;font-size:0.875rem;font-weight:600;">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</a>
      </div>

    </form>
  </main>
  <aside class="sidebar-right"></aside>
</div>

<nav class="bottom-nav">
  <a href="/" class="bottom-nav-item"><span class="bnav-icon">üè†</span><span>–°—Ç—Ä—ñ—á–∫–∞</span></a>
  <a href="/search" class="bottom-nav-item"><span class="bnav-icon">üîç</span><span>–ü–æ—à—É–∫</span></a>
  <div class="bottom-nav-post"><button class="bottom-nav-post-btn" onclick="openModal('modal-post')">Ôºã</button></div>
  <a href="/notifications" class="bottom-nav-item"><span class="bnav-icon">üîî</span><span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span></a>
  <a href="/profile/{{ session.username }}" class="bottom-nav-item active"><span class="bnav-icon">üë§</span><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></a>
</nav>

<script>
function previewAvatar(input) {
  if (input.files && input.files[0]) {
    const url = URL.createObjectURL(input.files[0]);
    const preview = document.getElementById('avatar-preview');
    preview.innerHTML = `<img src="${url}" class="avatar avatar-xl" style="object-fit:cover;width:88px;height:88px;">
      <div id="avatar-overlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;"><span style="color:white;font-size:1.3rem;">üì∑</span></div>`;
  }
}
const overlay = document.getElementById('avatar-overlay');
const preview = document.getElementById('avatar-preview');
if (preview && overlay) {
  preview.addEventListener('mouseenter', () => overlay.style.opacity = '1');
  preview.addEventListener('mouseleave', () => overlay.style.opacity = '0');
}
</script>
{% endblock %}